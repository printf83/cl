"use strict";import css from"./css/file.css";import*as core from"./core.js";import*as db from"./api.js";import div from"./div.js";import btngroup from"./btngroup.js";import button from"./button.js";import label from"./label.js";import modal from"./modal.js";import icon from"./icon.js";import span from"./span.js";import img from"./img.js";import input from"./input.js";import tag from"./tag.js";const defaultOption={label:null,labelsize:null,hidelabel:!1,readonly:!1,disabled:!1,multiple:!1,value:null,weight:null,accept:"image/gif,image/bmp,image/x-windows-bmp,image/jpeg,image/png,application/pdf,application/zip,application/json,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain,text/html",uploadlabel:"Upload",uploadicon:"arrow-up-from-bracket",uploadcolor:"primary",viewlabel:"View",viewicon:"eye",viewcolor:"success",deletelabel:null,deleteicon:"times",deletecolor:"danger",downloadicon:{icon:"arrow-right-to-bracket",rotate:90,weight:"2x",color:"muted"},uploadsignin:!0,downloadsignin:!1};let db_opt={};const fn={onview:e=>{let l=e.currentTarget,o=l.closest("div[data-cl-container]"),t=o.getAttribute("data-cl-container"),i=o.parentNode.querySelectorAll(`#${t}`)[0].value,a=db_opt[t];i&&db.file.info(i,(e=>{if(e)if(1===e.length)switch(e[0].mimetype){case"image/png":case"image/jpeg":case"image/gif":case"image/bmp":case"image/x-windows-bmp":new modal({icon:null,title:null,button:null,static:!1,size:"md",bodyclass:"p-1",elem:new img({container:"fluid",width:100,marginX:"auto",display:"block",rounded:!0,padding:0,"data-cl-file":e[0].id,src:db.file.url(e[0].id),click:e=>{let l=e.currentTarget,o=l.getAttribute("data-cl-file");a.downloadsignin?db.user.info({sender:l},(e=>{e&&db.file.download(o,l)})):db.file.download(o,l)}})}).show();break;default:a.downloadsignin?db.user.info({sender:l},(o=>{o&&db.file.download(e[0].id,l)})):db.file.download(e[0].id,l)}else{let l=12;switch(e.length){case 1:l=12;break;case 2:l=6;break;case 3:l=4;break;default:l=3}let o=[];e.forEach((e=>{switch(e.mimetype){case"image/png":case"image/jpeg":case"image/gif":case"image/bmp":case"image/x-windows-bmp":o.push(new div({col:l,padding:0,elem:new div({class:"btn",padding:1,border:!0,"data-cl-file":e.id,click:e=>{let l=e.currentTarget,o=l.getAttribute("data-cl-file");a.downloadsignin?db.user.info({sender:l},(e=>{e&&db.file.download(o,l)})):db.file.download(o,l)},elem:new img({container:"fluid",marginX:"auto",display:"block",rounded:!0,src:db.file.url(e.id)})})}));break;default:o.push(new div({display:"flex",alignItem:"stretch",col:l,padding:0,elem:new div({border:!0,padding:5,display:"flex",justifyContent:"center",class:"btn",width:100,"data-cl-file":e.id,click:e=>{let l=e.currentTarget,o=l.getAttribute("data-cl-file");a.downloadsignin?db.user.info({sender:l},(e=>{e&&db.file.download(o,l)})):db.file.download(o,l)},elem:new span({alignSelf:"center",elem:"object"==typeof a.downloadicon?new icon(a.downloadicon):new icon({icon:a.downloadicon,color:"muted",weight:"2x"})})})}))}})),new modal({icon:null,title:null,button:null,static:!1,size:"lg",elem:new div({container:!0,padding:0,elem:new div({display:"flex",justifyContent:"center",row:!0,gap:3,elem:o})})}).show()}}),l)},onchange:e=>{let l=e.currentTarget,o=l.parentNode.parentNode.querySelectorAll(".btn-group")[0],t=l.getAttribute("id"),i=db_opt[t];if(l.value){let e=o.querySelectorAll(`#${t}_upload`)[0];core.removeElement(e),core.appendChild(o,new button({id:`${t}_view`,label:i.viewlabel,icon:i.viewicon,color:i.viewcolor,width:100,click:fn.onview})),core.appendChild(o,new button({id:`${t}_delete`,label:i.deletelabel,icon:i.deleteicon,color:i.deletecolor,width:0,disabled:!!i.disabled||!!i.readonly,click:fn.ondelete}))}else{let e=o.querySelectorAll(`#${t}_view`)[0],l=o.querySelectorAll(`#${t}_delete`)[0];core.removeElement(e),core.removeElement(l),core.appendChild(o,new button({id:`${t}_upload`,label:i.uploadlabel,icon:i.uploadicon,color:i.uploadcolor,width:100,disabled:!!i.disabled||!!i.readonly,click:fn.onupload}))}},ondelete:e=>{let l=e.currentTarget.closest("div[data-cl-container]"),o=l.getAttribute("data-cl-container"),t=l.parentNode.querySelectorAll(`#${o}`)[0];t.value=null,t.dispatchEvent(new Event("change"))},startupload:(e,l,o,t,i)=>{core.appendChild(e,new span({id:`${t}-progress`,class:"cl-fu-progress"})),core.appendChild(document.body,new input({type:"file",id:t,multiple:i.multiple,accept:i.accept?i.accept:null,disply:"none",onchange:e=>{let t=e.currentTarget,i=t.getAttribute("id"),a=t.files;db.file.upload(a,(e=>{document.getElementById(`${i}-progress`).style.width=`${e}%`}),(e=>{core.removeElement(t),o.value=e,o.dispatchEvent(new Event("change"))}),l)}})),document.getElementById(t).click()},onupload:e=>{let l=e.currentTarget,o=l,t=l.closest("div[data-cl-container]"),i=t.getAttribute("data-cl-container"),a=db_opt[i],n=t.parentNode.querySelectorAll(`#${i}`)[0],d=core.UUID();a.uploadsignin?db.user.info({sender:l},(e=>{e&&fn.startupload(l,o,n,d,a)})):fn.startupload(l,o,n,d,a)},onsave:(e,l,o)=>{if(e){let t=e.value;t&&db.file.save(t,(e=>{"function"==typeof l&&l(e)}),o)}else"function"==typeof l&&l(null)},onsavevalue:(e,l,o)=>{e?db.file.save(e,(e=>{"function"==typeof l&&l(e)}),o):"function"==typeof l&&l(null)}};export default class file extends div{constructor(e){super(e)}get data(){return super.data}set data(e){let l=(e=core.extend({},defaultOption,e)).id||core.UUID();var o=[];e.label&&!e.hidelabel&&o.push(new label({for:l,label:e.label,class:e.labelsize?core.multiClass(e.labelsize,{format:"col-$1",formatTrue:"col",formatValue:"col-form-label"}):"form-label"})),o.push(new input({id:l,name:e.name,type:"hidden",onchange:fn.onchange,readonly:e.readonly,disabled:e.disabled,value:e.value})),o.push(new div({row:!0,"data-cl-container":l,elem:new btngroup({weight:e.weight,elem:e.value?[new button({id:`${l}_view`,label:e.viewlabel,icon:e.viewicon,color:e.viewcolor,width:100,click:fn.onview}),new button({id:`${l}_delete`,label:e.deletelabel,icon:e.deleteicon,color:e.deletecolor,width:"auto",disabled:!!e.disabled||!!e.readonly,click:fn.ondelete})]:[new button({id:`${l}_upload`,label:e.uploadlabel,icon:e.uploadicon,color:e.uploadcolor,width:100,disabled:!!e.disabled||!!e.readonly,click:fn.onupload})]})})),db_opt[l]={weight:e.weight,multiple:e.multiple,accept:e.accept,readonly:e.readonly,disabled:e.disabled,uploadlabel:e.uploadlabel,uploadicon:e.uploadicon,uploadcolor:e.uploadcolor,deletelabel:e.deletelabel,deleteicon:e.deleteicon,deletecolor:e.deletecolor,viewlabel:e.viewlabel,viewicon:e.viewicon,viewcolor:e.viewcolor,downloadicon:e.downloadicon,uploadsignin:e.uploadsignin,downloadsignin:e.downloadsignin},super.data={elem:o}}static save(e,l,o){"string"==typeof e?fn.onsavevalue(e,l,o):fn.onsave(e,l,o)}}