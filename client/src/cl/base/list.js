"use strict";import css from"./css/animation.css";import css2 from"./css/list.css";import*as core from"./core.js";import*as db from"./api.js";import*as query from"./query.js";import div from"./div.js";import paging from"./paging.js";import btngroup from"./btngroup.js";import img from"./img.js";import button from"./button.js";import*as dlg from"./dlg.js";import icon from"./icon.js";import h from"./h.js";import b from"./b.js";import li from"./li.js";import ul from"./ul.js";const fn={genname:e=>e?1===(e=Array.isArray(e)?e:[e]).length?`<b>${e[0]}</b>`:2===e.length?`<b>${e[0]}</b> and <b>${e[1]}</b>`:3===e.length?`<b>${e[0]}</b>, <b>${e[1]}</b> and <b>${e[2]}</b>`:`<b>${e[0]}</b>, <b>${e[1]}</b>, <b>${e[2]}</b> and <b>${e.length-3} more</b>`:null,set:(e,t,l)=>{t?(db_opt[e]||(console.warn(`db_opt['${e}'] not found`),db_opt[e]={}),db_opt[e][t]=l):db_opt[e]=core.extend({},defaultOption,l)},get:(e,t)=>db_opt[e]?t?db_opt[e][t]:db_opt[e]:null,reload:(e,t,l)=>{let i=fn.get(e);i&&db.api.list({name:i.name,data:i.query,sender:t},(t=>{let n=document.getElementById(e);core.removeChildElement(n),core.appendChild(n,i.container(t.data,i)),i.paging&&t.total>i.query.limit&&core.appendChild(n,new paging({total:t.total,skip:i.query.skip,limit:i.query.limit,change:fn.pagechange,autoupdate:!1,nextprev:!1,"data-cl-container":e})),core.init(n),"function"==typeof l&&l(n)}),t)},pagechange:e=>{let t=e.currentTarget.closest(".pagination").getAttribute("data-cl-container"),l=fn.get(t);l&&(l.query.skip=e.detail.skip,fn.set(t,null,l),fn.reload(t,e.detail.sender))},query:{all:(e,t)=>{let l=fn.get(e);l&&new query.dialog({field:l.setting?.field,limit:l.setting?.limit,skip:l.setting?.skip,useopricon:l.setting?.useopricon,data:l.query},[(i,n)=>{l.query=n,fn.set(e,null,l),fn.reload(e,t)}]).show()},filter:(e,t)=>{let l=fn.get(e);l&&new query.filter({field:l.setting?.field,useopricon:l.setting?.useopricon,data:l.query?.filter},[(i,n)=>{l.query.filter=n,fn.set(e,null,l),fn.reload(e,t)}]).show()},sort:(e,t)=>{let l=fn.get(e);l&&new query.sort({field:l.setting?.field,useopricon:l.setting?.useopricon,data:l.query?.sort},[(i,n)=>{l.query.sort=n,fn.set(e,null,l),fn.reload(e,t)}]).show()},field:(e,t)=>{let l=fn.get(e);l&&new query.field({field:l.setting?.field,data:l.query?.field},[(i,n)=>{l.query.field=n,fn.set(e,null,l),fn.reload(e,t)}]).show()},limit:(e,t)=>{let l=fn.get(e);l&&new query.limit({min:l.setting?.limit?.min,max:l.setting?.limit?.max,step:l.setting?.limit?.step,data:l.query?.limit},[(i,n)=>{let a=l.query.skip/l.query.limit;l.query.limit=n,l.query.skip=a*l.query.limit,fn.set(e,null,l),fn.reload(e,t)}]).show()},page:(e,t)=>{let l=fn.get(e);l&&new query.page({min:l.setting?.skip?.min,max:l.setting?.skip?.max,step:l.setting?.skip?.step,limit:l.query?.limit,data:l.query?.skip},[(i,n)=>{l.query.skip=n,fn.set(e,null,l),fn.reload(e,t)}]).show()}},excel:(e,t)=>{let l=fn.get(e);l&&db.api.excel({name:l.name,data:l.query,sender:t})},check:{get:e=>{let t=document.getElementById(e);if(t.classList.contains("check")){let e=t.querySelectorAll(".check[data-key]");if(e&&e.length>0)return Array.from(e).map((e=>({key:e.getAttribute("data-key"),name:e.getAttribute("data-name")})))}return null},set:(e,t)=>{if(t&&t.length>0){t=Array.isArray(t)?t:[t];let l=document.getElementById(e);if(l.classList.contains("check")){let e=l.querySelectorAll(".check[data-key]");e&&e.length>0&&Array.from(e).forEach((e=>{e.classList.remove("check")})),t.forEach((e=>{let t=l.querySelectorAll(`div[data-key='${e}']`);t&&t.length>0&&t[0]?.classList.add("check")}))}}},delete:(e,t)=>{let l=fn.get(e);if(l){let i=fn.check.get(e);if(i){let n=i.map((e=>e.key));if("function"==typeof l.check_delete)l.check_delete(n,t);else{const a=(e,l,i,n)=>{i<l.length?db.api.load({name:e.name,id:l[i],sender:t},(o=>{o?fn.file.delete(e,o,(()=>{a(e,l,i+1,n)}),t):a(e,l,i+1,n)}),t):n()},o=(e,t,l,i)=>{db.api.delete({name:t.name,id:l,sender:i},(t=>{fn.reload(e,i)}),i)};new dlg.confirmbox("!!",`Are you sure delete ${fn.genname(i.map((e=>e.name)))} record?`,[{label:"Yes, delete",color:"danger",click:()=>{l.file&&l.file.length>0?a(l,n,0,(()=>{o(e,l,n,t)})):o(e,l,n,t)}},{label:"Cancel"}],`Delete ${l.name}`).show()}}else new dlg.msgbox("-","No item selected.",(()=>{}),`Delete ${l.name}`).show()}},mode:(e,t)=>{void 0===t&&(t=!document.getElementById(e).classList.contains("check")),t?document.getElementById(e).classList.add("check"):document.getElementById(e).classList.remove("check")},all:e=>{let t=document.getElementById(e);if(t.classList.contains("check")){let e=t.querySelectorAll(".check[data-key]"),l=t.querySelectorAll("[data-key]");l.length===e.length?l.forEach((e=>{e.classList.remove("check")})):l.forEach((e=>{e.classList.add("check")}))}},item:e=>{e.stopPropagation();let t=e.currentTarget.closest("[data-key]");t.classList.contains("check")?t.classList.remove("check"):t.classList.add("check")}},file:{listoffile:(e,t)=>{let l=[];return e&&e.length>0&&e.forEach((e=>{t[e]&&(t[e].indexOf(",")>0?t[e].toString().split(",").forEach((e=>{l.push(e)})):l.push(t[e]))})),l&&l.length>0?l:null},listoffileobject:(e,t)=>{let l=[];return e&&e.length>0&&e.forEach((e=>{t[e]&&l.push({key:e,data:t[e]})})),l&&l.length>0?l:null},save:(e,t,l,i)=>{if(e&&t)if(e.file&&e.file.length>0){let n=fn.file.listoffile(e.file,t);n&&n.length>0?db.file.save(n,l,i):l()}else l()},delete:(e,t,l,i)=>{if(e&&t)if(e.file){let n=fn.file.listoffile(e.file,t);n&&n.length>0?db.file.delete(n,l,i):l()}else l()},duplicate:(e,t,l,i)=>{const n=(e,t,l,i,a)=>{l<t.length?db.file.duplicate(t[l].data,(o=>{e[t[l].key]=o,n(e,t,l+1,i,a)}),a):i(e)};if(e&&t)if(e.file&&e.file.length>0){let a=fn.file.listoffileobject(e.file,t);a&&a.length>0?n(t,a,0,l,i):l(t)}else l(t)},manage:(e,t,l,i,n)=>{if(e&&t&&l)if(e.file&&e.file.length>0){let a=fn.file.listoffile(e.file,t),o=fn.file.listoffile(e.file,l),r=[],s=[];o&&o.length>0&&o.forEach((e=>{a&&a.length>0&&a.includes(e)||s.push(e)})),a&&a.length>0&&a.forEach((e=>{o&&o.length>0&&o.includes(e)||r.push(e)})),s&&s.length>0?db.file.save(s,(()=>{r&&r.length>0?db.file.delete(r,i,n):i()}),n):r&&r.length>0?db.file.delete(r,i,n):i()}else i()}},item:{action:e=>{e.stopPropagation();let t=e.currentTarget.closest("[data-key]");if(t){t.closest(".cl-list").classList.contains("check")?fn.check.item(e):fn.item.edit(e,t)}},add:(e,t)=>{let l=fn.get(e);l&&("function"==typeof l.item_add?l.item_add(t):new dlg.inputbox(l.editor(null),null,[{label:"Save",click:(i,n)=>{db.api.create({name:l.name,data:n,sender:t},(i=>{i&&fn.file.save(l,n,(()=>{fn.reload(e,t)}),t)}),t)}},{label:"Cancel"}],`Add ${l.name}`).show())},menu:e=>{e.stopPropagation(),e.currentTarget.closest(".cl-list-ctl").classList.add("show");let t=e.currentTarget.closest("[data-key]"),l=t.getAttribute("data-key"),i=t.closest(".cl-list").getAttribute("id"),n=fn.get(i);n&&"function"==typeof n.item_menu&&n.item_menu(t,l)},edit:e=>{e.stopPropagation(),e.currentTarget.querySelectorAll(".cl-list-ctl")[0].classList.remove("show");let t=e.currentTarget.closest("[data-key]"),l=t.getAttribute("data-key"),i=t.closest(".cl-list").getAttribute("id"),n=fn.get(i);n&&("function"==typeof n.item_edit?n.item_edit(t,l):db.api.load({name:n.name,id:l,sender:t},(e=>{e&&new dlg.inputbox(n.editor(e),null,[{label:"Save",click:(a,o)=>{o._id=l,db.api.update({name:n.name,id:l,data:o,sender:t},(l=>{l&&fn.file.manage(n,e,o,(()=>{fn.reload(i,t)}),t)}))}},{label:"Cancel"}],`Edit ${n.name}`).show()}),t))},copy:e=>{e.stopPropagation(),e.currentTarget.closest(".cl-list-ctl").classList.remove("show");let t=e.currentTarget,l=t.closest("[data-key]"),i=l.getAttribute("data-key"),n=l.closest(".cl-list").getAttribute("id"),a=fn.get(n);a&&("function"==typeof a.item_copy?a.item_copy(l,i):db.api.load({name:a.name,id:i,sender:l},(e=>{e&&(delete e._id,fn.file.duplicate(a,e,(e=>{new dlg.inputbox(a.editor(e),null,[{label:"Save",click:(e,t)=>{db.api.create({name:a.name,data:t,sender:l},(e=>{e&&fn.file.save(a,t,(()=>{fn.reload(n,l)}),l)}))}},{label:"Cancel"}],`Copy ${a.name}`).show()}),l))}),t))},delete:e=>{e.stopPropagation(),e.currentTarget.closest(".cl-list-ctl").classList.remove("show");let t=e.currentTarget,l=t.closest("[data-key]"),i=l.getAttribute("data-key"),n=l.getAttribute("data-name"),a=l.closest(".cl-list").getAttribute("id"),o=fn.get(a);if(o)if("function"==typeof o.item_delete)o.item_delete(l,i);else{const e=(e,t,l,i)=>{db.api.delete({name:e.name,id:l,sender:i},(e=>{fn.reload(t,i)}))};new dlg.confirmbox("!!",`Are you sure delete <b>${n||"this"}</b> record?`,[{label:"Yes, delete",color:"danger",click:()=>{o.file&&o.file.length>0?db.api.load({name:o.name,id:i,sender:l},(n=>{n?fn.file.delete(o,n,(()=>{e(o,a,i,l)}),t):e(o,a,i,l)}),l):e(o,a,i,l)}},{label:"Cancel"}],`Delete ${o.name}`).show()}},more:e=>{e.stopPropagation(),e.currentTarget.closest(".cl-list-ctl").classList.remove("show");let t=e.currentTarget.closest("[data-key]"),l=t.getAttribute("data-key"),i=t.closest(".cl-list").getAttribute("id"),n=fn.get(i);n&&"function"==typeof n.item_more&&n.item_more(t,l)}}},db_opt={},defaultOption={view:"list",setting:null,query:null,name:null,paging:!0,item_add:null,item_menu:null,item_edit:null,item_copy:null,item_delete:null,item_more:null,check_delete:null,allow_action:!1,allow_copy:!1,allow_delete:!1,allow_more:!1,container:(e,t)=>new ul({class:"list-group",elem:t.row(e,t)}),row:(e,t)=>e.map((e=>t.item(e,t))),item:(e,t)=>new item({name:JSON.stringify(e).replace(/\,/g,",<br/>").replace(/\:/g,": ").replace(/\{/g,"{<br/>").replace(/\}/g,"<br/>}")}),group:(e,t)=>new group({name:JSON.stringify(e).replace(/\,/g,",<br/>").replace(/\:/g,": ").replace(/\{/g,"{<br/>").replace(/\}/g,"<br/>}")})},defaultItemOption={view:"list",key:null,picture:null,name:null,detail:null,allow_action:void 0,allow_copy:void 0,allow_delete:void 0,allow_more:void 0},defaultGroupOption={view:"list",key:null,name:null};export class container extends div{constructor(...e){super(...e)}get data(){return super.data}set data(e){e&&(e=core.extend({},defaultOption,e),e=core.merge(e,{id:e.id||core.UUID(),class:"cl-list"}),fn.set(e.id,null,core.extend({},e)),delete e.setting,delete e.query,delete e.name,delete e.paging,delete e.container,delete e.row,delete e.item,delete e.group,delete e.item_add,delete e.item_copy,delete e.item_delete,delete e.item_edit,delete e.item_menu,delete e.item_more,delete e.check_delete,delete e.allow_action,delete e.allow_copy,delete e.allow_delete,delete e.allow_more,delete e.view,super.data=e)}static get=fn.get;static set=fn.set;static reload=fn.reload;static query=fn.query;static excel=fn.excel;static check=fn.check;static item=fn.item}export class item extends li{constructor(...e){super(...e)}get data(){return super.data}set data(e){e=core.extend({},defaultItemOption,e),e=core.merge(e,{class:["list-group-item",e.allow_action?"pointer":null],"data-key":e.key,"data-name":e.name,display:"flex",justifyContent:"between",click:e.allow_action?fn.item.action:null,elem:[new div({display:"flex",justifyContent:"start",alignSelf:"center",elem:[new div({display:"flex",alignSelf:"center",justifyContent:"center",elem:[e.picture?new div({class:"cl-list-img",marginEnd:3,width:"3rem",elem:new img({fluid:!0,rounded:!0,src:db.file.url(e.picture)})}):null,new icon({class:"cl-list-check",marginEnd:3,icon:"check",color:"secondary",weight:"2x"})]}),new div({elem:[new h({level:6,elem:e.name}),e.detail?new div(e.detail):null]})]}),e.allow_copy||e.allow_delete||e.allow_more?new div({class:"cl-list-ctl",display:"flex",alignSelf:"center",click:fn.item.menu,elem:new btngroup({elem:[e.allow_more?new button({icon:"cog",color:"primary",click:fn.item.more}):null,e.allow_copy?new button({icon:"copy",color:"success",click:fn.item.copy}):null,e.allow_delete?new button({icon:"trash",color:"danger",click:fn.item.delete}):null].filter(Boolean)})}):null]}),super.data=e}}export class group extends li{constructor(...e){super(...e)}get data(){return super.data}set data(e){e=core.extend({},defaultGroupOption,e),delete(e=core.merge(e,{class:["list-group-item","list-group-item-header"],elem:new b(e.name)})).name,super.data=e}}