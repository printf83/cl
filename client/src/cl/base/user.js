"use strict";import*as core from"./core.js";import input from"./input.js";import*as container from"./container.js";import div from"./div.js";import icon from"./icon.js";import h from"./h.js";import button from"./button.js";import form from"./form.js";import*as db from"./api.js";import modal from"./modal.js";import*as dlg from"./dlg.js";import*as alert from"./alert.js";import btnclose from"./btnclose.js";import file from"./file.js";import a from"./a.js";import small from"./small.js";import tag from"./tag.js";import toast from"./toast.js";const defaultIconWeight="4x",defaultIconColor="primary",defaultSize="md",defaultSizeBanner="xl",defaultMaxWidth=null,defaultMaxWidthBanner=null,defaultTitleSize=5;let defaultSignInOption={id:null,icon:null,msg:null,size:null,title:null,email:null,callback:null,close:!0,backdropcolor:"primary",debug:!1},defaultSignUpOption={id:null,icon:null,msg:null,size:null,title:null,callback:null,close:!0,backdropcolor:"primary",debug:!1},defaultResetPassOption={id:null,icon:null,msg:null,size:null,title:null,callback:null,close:!0,backdropcolor:"primary",debug:!1},defaultChangePassOption={id:null,icon:null,msg:null,size:null,title:null,callback:null,close:!0,debug:!1},defaultChangePassGuestOption={id:null,icon:null,msg:null,size:null,token:null,title:null,callback:null,close:!0,backdropcolor:"primary",debug:!1},defaultUpdateInfoOption={id:null,icon:null,msg:null,size:null,token:null,title:null,callback:null,close:!0,debug:!1,data:null};const fn={banner:(e,n)=>core.setting.banner&&"function"==typeof core.setting.banner?new div({row:!0,elem:[new div({col:8,display:["none","lg-block"],elem:new div({display:"flex",alignItem:"center",height:100,elem:core.setting.banner(e)})}),new div({col:[12,"lg-4"],elem:new div({display:"flex",alignItem:"center",height:100,elem:n})})]}):n,header:(e,n)=>[n.icon?new icon(n.icon):new icon(core.setting.icon("primary","4x")),new tag({col:!0,marginY:0,elem:new small({textColor:"muted",elem:core.setting.title()})}),new tag({col:!0,marginY:0,elem:new h({level:5,marginY:0,elem:n.title?n.title:e})}),new tag({col:!0,display:n.msg?"null":"none",elem:new div({id:`${n.id}_msg`,elem:fn.msg(n.msg,"i")})})].filter(Boolean),msg:(e,n)=>new alert.container({textAlign:"start",marginBottom:0,icon:n,elem:e}),showmsg:(e,n,o)=>{let a=e.getAttribute("id"),t=document.getElementById(`${a}_msg`),l=t.parentElement;core.removeChildElement(t),n?(l.classList.remove("d-none"),core.appendChild(t,fn.msg(n,o))):l.classList.add("d-none")},closebtn:e=>e.debug?null:new div({position:"relative",elem:new div({position:"absolute",width:100,elem:new div({display:"flex",justifyContent:"end",elem:new btnclose({click:n=>{let o=n.currentTarget.closest("div.modal");e.callback instanceof Function&&e.callback(!1),modal.hide(o)}})})})}),modalbulder:(e,n,o)=>({title:null,icon:null,size:o.size?o.size:core.setting.banner?"xl":"md",maxWidth:(core.setting.banner,null),backdropcolor:o.backdropcolor,elem:[o.close?fn.closebtn(o):null,fn.banner(e,fn.form.container(o.id,n(o)))].filter(Boolean)}),modalbodybuilder:(e,n,o,a)=>{let t=e.closest("div.modal-body");core.replaceWith(t,new div({class:"modal-body",elem:[a.close?fn.closebtn(a):null,fn.banner(n,fn.form.container(a.id,o(a)))]}))},action:{inputchange:e=>{let n=e.currentTarget.closest("form");fn.showmsg(n,null)},signout:(e,n)=>{new dlg.confirmbox("!!","Are you sure to <b>Sign out</b> now?",[{label:"Yes",click:()=>{db.user.signout({sender:e},(o=>{n(o),core.setting.userchange&&"function"==typeof core.setting.userchange&&fn.action.info_guest(e,(function(e){core.setting.userchange(e)}))}))}},{label:"No"}]).show()},signin:(e,n)=>{let o=e.closest("form");core.validate(o,(a=>{if(a){let a=core.getValue(o);o.classList.remove("was-validated"),db.user.signin({sender:e,data:{username:a.email,password:a.password,remember:!(!a.remember||1!==a.remember.length||"on"!==a.remember[0])}},(a=>{if(a)if(a.success){if(n.callback instanceof Function){let e=o.closest("div.modal");modal.hide(e),n.callback(!0)}core.setting.userchange&&"function"==typeof core.setting.userchange&&fn.action.info_guest(e,(function(e){core.setting.userchange(e)}))}else fn.showmsg(o,a&&a.message?a.message:null,"!!")}))}else fn.showmsg(o,"Please provide email and password","-")}))},signup:(e,n)=>{let o=e.closest("form");core.validate(o,(a=>{if(a){let a=core.getValue(o);a.password!==a.password2?fn.showmsg(o,"Password and retry password not match","-"):(o.classList.remove("was-validated"),db.user.register({sender:e,data:{username:a.email,password:a.password}},(e=>{if(e)if(e.success)if(n.callback instanceof Function){let e=o.closest("div.modal");modal.hide(e),n.callback(!0)}else fn.showmsg(o,"Sign up success. Please check your email for validation.","/");else fn.showmsg(o,e&&e.message?e.message:null,"!!")})))}else fn.showmsg(o,"Please provide email and password","-")}))},resetpass:(e,n)=>{let o=e.closest("form");core.validate(o,(a=>{if(a){let a=core.getValue(o);o.classList.remove("was-validated"),db.user.resetpass({sender:e,data:{username:a.email}},(e=>{if(e)if(e.success)if(n.callback instanceof Function){let e=o.closest("div.modal");modal.hide(e),n.callback(!0)}else fn.showmsg(o,"Please check your email to continue reset password","/");else fn.showmsg(o,e&&e.message?e.message:null,"!!")}))}else fn.showmsg(o,"Please provide email","-")}))},changepass:(e,n)=>{let o=e.closest("form");core.validate(o,(a=>{if(a){let a=core.getValue(o);a.password!==a.password2?fn.showmsg(o,"Password and retry password not match","-"):(o.classList.remove("was-validated"),db.user.changepass({sender:e,data:{oldpassword:a.oldpassword,password:a.password}},(e=>{if(e)if(e.success)if(n.callback instanceof Function){let e=o.closest("div.modal");modal.hide(e),n.callback(!0)}else fn.showmsg(o,"Password changed. Please use your new password next time you sign in.","/");else fn.showmsg(o,e&&e.message?e.message:null,"!!")})))}else fn.showmsg(o,"Please provide old password, new password and repeat new password","-")}))},changepass_guest:(e,n)=>{let o=e.closest("form");core.validate(o,(a=>{if(a){let a=core.getValue(o);a.password!==a.password2?fn.showmsg(o,"Password and retry password not match","-"):(o.classList.remove("was-validated"),db.user.changepass_guest({sender:e,data:{token:a.token,password:a.password}},(e=>{if(e)if(e.success)if(n.callback instanceof Function){let e=o.closest("div.modal");modal.hide(e),n.callback(!0)}else fn.showmsg(o,"Password changed. Please use your new password to sign in.","/");else fn.showmsg(o,e&&e.message?e.message:null,"!!")})))}else fn.showmsg(o,"Please provide new password and repeat new password","-")}))},info:(e,n)=>{db.user.info({sender:e},(e=>{n(e)}))},info_guest:(e,n)=>{db.user.info_guest({sender:e},(e=>{n(e)}))},managepicture:(e,n,o,a)=>{let t=null,l=null;o&&(n?n!==o&&(l=o):l=o),n&&(o?n!==o&&(t=n):t=n),l?db.file.save(l,(()=>{t?db.file.delete(t,a,e):a()}),e):t?db.file.delete(t,a,e):a()},updateinfo:(e,n)=>{let o=e.closest("form");core.validate(o,(a=>{if(a){o.classList.remove("was-validated");let a=core.getValue(o);db.user.info(e,(t=>{fn.action.managepicture(e,t.picture,a.picture,(()=>{db.user.updateinfo({sender:e,data:{email:a.email,name:a.name,picture:a.picture}},(a=>{if(a)if(a.success){if(n.callback instanceof Function){let e=o.closest("div.modal");modal.hide(e),n.callback(!0)}core.setting.userchange&&"function"==typeof core.setting.userchange&&fn.action.info_guest(e,(function(e){core.setting.userchange(e)}))}else fn.showmsg(o,a&&a.message?a.message:null,"!!")}))}))}))}else fn.showmsg(o,"Please provide contact email and name","-")}))},validate:(e,n)=>{db.user.validate(e,(e=>{n(e)}))}},form:{container:(e,n)=>new form({id:e,textAlign:"center",rowCol:1,elem:n.map((e=>new div({col:!0,elem:e})))}),signin:e=>fn.header("Sign in",e).concat([new input({before:new icon("at"),name:"email",type:"email",placeholder:"Email address",required:!0,autocomplete:"email",value:e.email,change:fn.action.inputchange}),new input({before:new icon("key"),name:"password",type:"password",placeholder:"Password",required:!0,minlengh:8,autocomplete:"current-password",change:fn.action.inputchange}),new div({display:"flex",justifyContent:"center",elem:new input({type:"checkbox",name:"remember",label:"Remember me"})}),new container.grid([new button({label:"Sign in",icon:"arrow-right-to-bracket",color:"primary",click:e.debug?null:n=>{fn.action.signin(n.currentTarget,e)}}),new div({display:"flex",justifyContent:"between",elem:[new button({weight:"sm",color:"transparent",elem:"Reset password",click:n=>{let o=n.currentTarget;fn.modalbodybuilder(o,"resetpass",fn.form.resetpass,e)}}),new button({weight:"sm",color:"transparent",elem:"Sign up",click:n=>{let o=n.currentTarget;fn.modalbodybuilder(o,"signup",fn.form.signup,e)}})]})])].filter(Boolean)),signup:e=>fn.header("Sign up",e).concat([new input({before:new icon("at"),name:"email",type:"email",placeholder:"Email address",required:!0,floatlabel:!0,autocomplete:"email",change:fn.action.inputchange}),new input({before:new icon("key"),name:"password",type:"password",placeholder:"Password",required:!0,minlengh:8,autocomplete:"new-password",change:fn.action.inputchange}),new input({before:new icon("key"),name:"password2",type:"password",placeholder:"Repeat password",required:!0,minlengh:8,autocomplete:"new-password",change:fn.action.inputchange}),core.setting.term&&"function"==typeof core.setting.term?new div({elem:new small({textColor:"muted",elem:["By clicking sign up you are agreeing to the ",new a({href:"#",click:core.setting.term,elem:"Terms and Conditions"}),"."]})}):null,new container.grid([new button({label:"Sign up",icon:"arrow-up-from-bracket",color:"primary",click:e.debug?null:n=>{fn.action.signup(n.currentTarget,e)}}),new div({display:"flex",justifyContent:"between",elem:[new button({weight:"sm",color:"transparent",elem:"Reset password",click:n=>{let o=n.currentTarget;fn.modalbodybuilder(o,"resetpass",fn.form.resetpass,e)}}),new button({weight:"sm",color:"transparent",elem:"Sign in",click:n=>{let o=n.currentTarget;fn.modalbodybuilder(o,"signin",fn.form.signin,e)}})]})])].filter(Boolean)),resetpass:e=>fn.header("Reset password",e).concat([new input({before:new icon("at"),name:"email",type:"email",placeholder:"Email address",required:!0,autocomplete:"email",change:fn.action.inputchange}),new container.grid([new button({label:"Send email",icon:"arrow-up-from-bracket",color:"primary",click:e.debug?null:n=>{fn.action.resetpass(n.currentTarget,e)}}),new div({display:"flex",justifyContent:"between",elem:[new button({weight:"sm",color:"transparent",elem:"Sign in",click:n=>{let o=n.currentTarget;fn.modalbodybuilder(o,"signin",fn.form.signin,e)}}),new button({weight:"sm",color:"transparent",elem:"Sign up",click:n=>{let o=n.currentTarget;fn.modalbodybuilder(o,"signup",fn.form.signup,e)}})]})].filter(Boolean))].filter(Boolean)),changepass:e=>fn.header("Change password",e).concat([new input({before:new icon("key"),name:"oldpassword",type:"password",placeholder:"Old password",required:!0,minlengh:8,autocomplete:"current-password",change:fn.action.inputchange}),new input({before:new icon("key"),name:"password",type:"password",placeholder:"New password",required:!0,minlengh:8,autocomplete:"new-password",change:fn.action.inputchange}),new input({before:new icon("key"),name:"password2",type:"password",placeholder:"Repeat new password",required:!0,minlengh:8,autocomplete:"new-password",change:fn.action.inputchange}),new container.grid([new button({label:"Change password",icon:"floppy-disk",color:"primary",click:e.debug?null:n=>{fn.action.changepass(n.currentTarget,e)}}),new div({display:"flex",justifyContent:"between",elem:[new button({weight:"sm",color:"transparent",elem:"Update profile",click:n=>{let o=n.currentTarget;fn.action.info(o,(n=>{n&&(e.data=n,fn.modalbodybuilder(o,"updateinfo",fn.form.updateinfo,e))}))}}),new button({weight:"sm",color:"transparent",elem:"Sign out",click:n=>{let o=n.currentTarget;fn.action.signout(o,(()=>{fn.modalbodybuilder(o,"signin",fn.form.signin,e)}))}})]})])].filter(Boolean)),changepass_guest:e=>fn.header("Change password",e).concat([new tag({col:!0,display:"none",elem:new input({name:"token",type:"hidden",value:e.token})}),new input({before:new icon("key"),name:"password",type:"password",placeholder:"New password",required:!0,minlengh:8,autocomplete:"new-password",change:fn.action.inputchange}),new input({before:new icon("key"),name:"password2",type:"password",placeholder:"Repeat new password",required:!0,minlengh:8,autocomplete:"new-password",change:fn.action.inputchange}),new container.grid([new button({label:"Change password",icon:"floppy-disk",color:"primary",click:e.debug?null:n=>{fn.action.changepass_guest(n.currentTarget,e)}}),new div({display:"flex",justifyContent:"between",elem:[new button({weight:"sm",color:"transparent",elem:"Sign in",click:n=>{let o=n.currentTarget;fn.modalbodybuilder(o,"signin",fn.form.signin,e)}}),new button({weight:"sm",color:"transparent",elem:"Reset password",click:n=>{let o=n.currentTarget;fn.modalbodybuilder(o,"resetpass",fn.form.resetpass,e)}})]})])].filter(Boolean)),updateinfo:e=>fn.header("Update info",e).concat([new file({name:"picture",value:e&&e.data?e.data.picture:null,uploadlabel:"Upload picture",uploadicon:"user",uploadcolor:"secondary",viewlabel:"View picture",viewicon:"user"}),new input({before:new icon("envelope"),name:"email",type:"email",placeholder:"Contact email",required:!0,autocomplete:"email",value:e.data?.email,change:fn.action.inputchange}),new input({before:new icon("tag"),name:"name",type:"text",placeholder:"Name",required:!0,autocomplete:"username",value:e.data?.name,change:fn.action.inputchange}),new container.grid([new button({label:"Update profile",icon:"arrow-up-from-bracket",color:"primary",click:e.debug?null:n=>{fn.action.updateinfo(n.currentTarget,e)}}),new div({display:"flex",justifyContent:"between",elem:[new button({weight:"sm",color:"transparent",elem:"Change password",click:n=>{let o=n.currentTarget;fn.modalbodybuilder(o,"changepass",fn.form.changepass,e)}}),new button({weight:"sm",color:"transparent",elem:"Sign out",click:n=>{let o=n.currentTarget;fn.modalbodybuilder(o,"signout",fn.form.signout,e)}})]})])].filter(Boolean))}};export function info(e,n){fn.action.info(e,n)}export function info_guest(e,n){fn.action.info_guest(e,n)}export function signout(e,n){fn.action.signout(e,n)}export function validate(e,n){fn.action.validate(e,n)}export class signin extends modal{constructor(e){(e=core.extend({},defaultSignInOption,e)).id=e.id||core.UUID();let n=fn.modalbulder("signin",fn.form.signin,e);e.debug&&(n.debug=!0),super(n)}}export class signup extends modal{constructor(e){(e=core.extend({},defaultSignUpOption,e)).id=e.id||core.UUID();let n=fn.modalbulder("signup",fn.form.signup,e);e.debug&&(n.debug=!0),super(n)}}export class resetpass extends modal{constructor(e){(e=core.extend({},defaultResetPassOption,e)).id=e.id||core.UUID();let n=fn.modalbulder("resetpass",fn.form.resetpass,e);e.debug&&(n.debug=!0),super(n)}}export class changepass extends modal{constructor(e){(e=core.extend({},defaultChangePassOption,e)).id=e.id||core.UUID();let n=fn.modalbulder("changepass",fn.form.changepass,e);e.debug&&(n.debug=!0),super(n)}}export class changepass_guest extends modal{constructor(e){(e=core.extend({},defaultChangePassGuestOption,e)).id=e.id||core.UUID();let n=fn.modalbulder("changepass_guest",fn.form.changepass_guest,e);e.debug&&(n.debug=!0),super(n)}}export class updateinfo extends modal{constructor(e){(e=core.extend({},defaultUpdateInfoOption,e)).id=e.id||core.UUID();let n=fn.modalbulder("updateinfo",fn.form.updateinfo,e);e.debug&&(n.debug=!0),super(n)}}