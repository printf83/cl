"use strict";import*as core from"./core.js";import{signin as user_signin}from"./user.js";const defaultOption={callback:e=>{},type:"GET",url:null,data:null,async:!0,auth:!0},defaultOptionPost={callback:e=>{},type:"POST",url:null,data:null,async:!0,auth:!0},defaultOptionUpload={callback:e=>{},progress:null,type:"POST",url:null,data:null,async:!1,auth:!0},defaultOptionDownload={callback:e=>{},type:"GET",url:null,data:null,async:!0,auth:!0},fn={str2Object:e=>{if(e&&""!==e)try{return JSON.parse(e)}catch{return e}return null},obj2String:e=>{if(e)try{return JSON.stringify(e)}catch{return e}return null},sender:{islist:e=>!!(e&&e.getAttribute("data-key")&&e.getAttribute("data-name")),isfree:e=>!e||!e.classList?.contains("disabled")&&!0!==e.disabled,setbusy:e=>{if(e&&(e.classList.add("disabled"),e.classList.add("wait"),e.setAttribute("disabled","disabled"),!fn.sender.islist(e))){let n=e.querySelectorAll("i");n&&n.length>0&&(n[0].setAttribute("data-old-class",n[0].getAttribute("class")),n[0].setAttribute("class","fas fa-circle-notch fa-fw fa-spin"))}},setfree:e=>{if(e&&(e.classList.remove("disabled"),e.classList.remove("wait"),e.removeAttribute("disabled"),!fn.sender.islist(e))){let n=e.querySelectorAll("i");n&&n.length>0&&(n[0].setAttribute("class",n[0].getAttribute("data-old-class")),n[0].setAttribute("data-old-class",null))}}},get:e=>{e=core.extend({},defaultOption,e);let n=new XMLHttpRequest;n.onreadystatechange=()=>{4==n.readyState&&(200==n.status?e.callback(fn.str2Object(n.responseText)):401===n.status&&e.auth?new user_signin({callback:n=>{n?fn.get(e):e.callback(null)}}).show():e.callback(null))},n.open(e.type,e.url,e.async),n.setRequestHeader("Content-Type","application/json"),n.send(fn.obj2String(e.data))},post:e=>{e=core.extend({},defaultOptionPost,e);let n=new XMLHttpRequest;n.onreadystatechange=()=>{4==n.readyState&&(200==n.status?e.callback(fn.str2Object(n.responseText)):401===n.status&&e.auth?new user_signin({callback:n=>{n?fn.post(e):e.callback(null)}}).show():e.callback(null))},n.open(e.type,e.url,e.async),n.setRequestHeader("Content-Type","application/json"),n.send(fn.obj2String(e.data))},upload:e=>{e=core.extend({},defaultOptionUpload,e);let n=new XMLHttpRequest;n.onreadystatechange=()=>{4==n.readyState&&(200==n.status?e.callback(fn.str2Object(n.responseText)):401===n.status&&e.auth?new user_signin({callback:n=>{n?fn.upload(e):e.callback(null)}}).show():e.callback(null))},"function"==typeof e.progress&&(n.onprogress=n=>{if(n.lengthComputable){var r=parseInt(n.loaded/n.total*100,10);e.progress(r)}}),n.open(e.type,e.url,e.async),n.send(fn.genfileformdata(e.data))},genformdata:e=>{if(e){const n=new FormData;return Object.keys(e).forEach((r=>n.append(r,e[r]))),n}return null},genfileformdata:e=>{let n=new FormData;for(let r=0;r<e.length;r++)n.append("file",e[r]);return n},getfilelength:e=>{let n=0;for(let r=0;r<e.length;r++)n+=e[0].length;return n}};export const api={create:(e,n)=>{(e=core.extend({},{name:null,data:null,sender:null},e)).name&&e.data?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.post({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:`api/${e.name}`,data:e.data})):console.error("opt name and data is required")},load:(e,n)=>{(e=core.extend({},{name:null,id:null,sender:null},e)).name&&e.id?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.get({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:`api/${e.name}/${Array.isArray(e.id)?e.id.join(","):e.id}`})):console.error("opt name and id is required")},update:(e,n)=>{(e=core.extend({},{name:null,id:null,data:null,sender:null},e)).name&&e.id&&e.data?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.get({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},type:"PUT",url:`api/${e.name}/${Array.isArray(e.id)?e.id.join(","):e.id}`,data:e.data})):console.error("opt name, id and data is required")},delete:(e,n)=>{(e=core.extend({},{name:null,id:null,sender:null},e)).name&&e.id?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.get({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},type:"DELETE",url:`api/${e.name}/${Array.isArray(e.id)?e.id.join(","):e.id}`})):console.error("opt name and id is required")},list:(e,n)=>{(e=core.extend({},{name:null,data:null,sender:null},e)).name?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.post({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:`api/${e.name}-list`,data:e.data})):console.error("opt name is required")},option:(e,n)=>{(e=core.extend({},{name:null,filter:null,limit:null,skip:null,fieldkey:"_id",fieldname:"name",emptylabel:null,sender:null},e)).name&&e.fieldkey&&e.fieldname?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.post({callback:r=>{if(r){var s=r.data?r.data.map((n=>({value:n[e.fieldkey],label:n[e.fieldname]}))):[];null!==e.emptylabel&&s.unshift({value:"",label:e.emptylabel}),fn.sender.setfree(e.sender),"function"==typeof n&&n(s)}else fn.sender.setfree(e.sender),"function"==typeof n&&n(null)},url:`api/${e.name}-list`,data:{filter:e.filter,limit:e.limit,skip:e.skip,field:{[e.fieldkey]:1,[e.fieldname]:1},sort:{[e.fieldname]:1}}})):console.error("opt name, fieldkey and fieldname is required")},excel:e=>{(e=core.extend({},{name:null,data:null,sender:null},e)).name?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),setTimeout((e=>{fn.sender.setfree(e)}),3e3,e.sender),window.location=api.url(e.name,e.data)):console.error("opt name is required")},url:(e,n)=>n?`api/${e}-excel/?q=${JSON.stringify(n)}`:`api/${e}-excel`,aggregate:(e,n)=>{(e=core.extend({},{name:null,data:null,sender:null},e)).name?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.post({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:`api/${e.name}-aggregate`,data:e.data})):console.error("opt name is required")}};export const file={upload:(e,n,r,s)=>{e?fn.sender.isfree(s)&&(fn.sender.setbusy(s),fn.upload({progress:n,callback:e=>{fn.sender.setfree(s),"function"==typeof r&&r(e)},url:"/api/file",data:e})):console.error("opt file is required")},download:(e,n)=>{window.location=file.url(e)},url:e=>e?`api/file/${Array.isArray(e)?e.join(","):e}`:(console.error("opt id is required"),null),info:(e,n,r)=>{e?fn.sender.isfree(r)&&(fn.sender.setbusy(r),fn.get({callback:e=>{fn.sender.setfree(r),"function"==typeof n&&n(e)},url:`/api/file-info/${Array.isArray(e)?e.join(","):e}`})):console.error("opt id is required")},duplicate:(e,n,r)=>{e?fn.sender.isfree(r)&&(fn.sender.setbusy(r),fn.get({callback:e=>{fn.sender.setfree(r),"function"==typeof n&&n(e)},url:`/api/file-duplicate/${Array.isArray(e)?e.join(","):e}`})):console.error("opt id is required")},save:(e,n,r)=>{e?fn.sender.isfree(r)&&(fn.sender.setbusy(r),fn.get({callback:e=>{fn.sender.setfree(r),"function"==typeof n&&n(e)},url:`/api/file/${Array.isArray(e)?e.join(","):e}`,type:"PUT"})):console.error("opt id is required")},delete:(e,n,r)=>{e?fn.sender.isfree(r)&&(fn.sender.setbusy(r),fn.get({callback:e=>{fn.sender.setfree(r),"function"==typeof n&&n(e)},url:`/api/file/${Array.isArray(e)?e.join(","):e}`,type:"DELETE"})):console.error("opt id is required")}};export const user={register:(e,n)=>{(e=core.extend({},{data:null,sender:null},e)).data?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.post({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:"api/user/register",data:e.data})):console.error("opt data is required")},signin:(e,n)=>{(e=core.extend({},{data:null,sender:null},e)).data?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.post({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:"api/user/signin",data:e.data})):console.error("opt data is required")},signout:(e,n)=>{e=core.extend({},{sender:null},e),fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.get({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:"api/user/signout"}))},changepass:(e,n)=>{(e=core.extend({},{data:null,sender:null},e)).data?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.post({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:"api/user/changepass",data:e.data})):console.error("opt data is required")},changepass_guest:(e,n)=>{(e=core.extend({},{data:null,sender:null},e)).data?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.post({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:"api/user/changepass-guest",data:e.data})):console.error("opt data is required")},resetpass:(e,n)=>{(e=core.extend({},{data:null,sender:null},e)).data?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.post({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:"api/user/resetpass",data:e.data})):console.error("opt data is required")},info_guest:(e,n)=>{e=core.extend({},{sender:null},e),fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.get({auth:!1,callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:"api/user/info"}))},info:(e,n)=>{e=core.extend({},{sender:null},e),fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.get({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:"api/user/info"}))},updateinfo:(e,n)=>{(e=core.extend({},{data:null,sender:null},e)).data?fn.sender.isfree(e.sender)&&(fn.sender.setbusy(e.sender),fn.post({callback:r=>{fn.sender.setfree(e.sender),"function"==typeof n&&n(r)},url:"api/user/updateinfo",data:e.data})):console.error("opt data is required")},validate:(e,n)=>{fn.post({callback:e=>{"function"==typeof n&&n(e)},url:"api/user/validate",data:{token:e}})}};