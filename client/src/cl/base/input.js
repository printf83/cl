"use strict";import*as core from"./core.js";import tag from"./tag.js";import label from"./label.js";import button from"./button.js";import*as inputgroup from"./inputgroup.js";import div from"./div.js";import*as option from"./option.js";import toast from"./toast.js";import*as dlg from"./dlg.js";import*as db from"./api.js";const defaultOption={type:"text",label:null,hidelabel:!1,floatlabel:!1,inline:!1,labelsize:null,ctlsize:null,size:null,weight:null,helper:null,option:null,numctl:!1,addctl:!1,deletectl:!1,editctl:!1,clearctl:!1,copyctl:!1,managectl:!1,validitytype:"feedback",valid:null,invalid:null,before:null,after:null,plaintext:!1,container:!0,flex:!1,badge:null,dbname:null,fieldkey:"_id",fieldname:"name",modify:null};export default class input extends tag{constructor(...e){super(...e)}get data(){return super.data}set data(e){if(e){e=core.extend({},defaultOption,e);let l=core.extend({},e);l.floatlabel&&(l.label||l.hidelabel||(l.floatlabel=!1),["checkbox","radio","switch","file"].includes(l.type)||l.readonly?l.floatlabel=!1:l.label&&!l.placeholder&&(l.placeholder=l.label)),(l.label&&!l.id||l.helper||l.option&&"select"!==l.type)&&(l.id=core.UUID()),(l.addctl||l.deletectl||l.editctl||l.copyctl||l.clearctl)&&(l.after=null),l.numctl&&"number"===l.type&&(l.before=null,l.after=null);let t=[];l.before?"string"==typeof l.before||l.before.hasOwnProperty("clicon")?t.push(new inputgroup.text({elem:l.before})):t.push(new tag({elem:l.before})):"number"===l.type&&l.numctl&&t.push(new button({icon:"minus",color:"secondary",click:e=>{let l=e.currentTarget.parentElement.getElementsByTagName("input")[0],t=parseInt(l.value),a=parseInt(l.min),n=parseInt(l.step);t=t||a,n=n||1,l.value=t-n,t-n<a&&(l.value=a)}}));let a=[];l.after?"string"==typeof l.after||l.after.hasOwnProperty("clicon")?a.push(new inputgroup.text({elem:l.after})):a.push(new tag({elem:l.after})):("number"===l.type&&l.numctl&&a.push(new button({icon:"plus",color:"secondary",click:e=>{let t=document.getElementById(l.id),a=parseInt(t.value),n=parseInt(t.max),i=parseInt(t.min),d=parseInt(t.step);a=a||i,d=d||1,t.value=a+d,a+d>n&&(t.value=n)}})),"function"!=typeof l.clearctl&&!0!==l.clearctl||("function"==typeof l.clearctl?a.push(new button({icon:"delete-left",color:"secondary",click:l.clearctl})):a.push(new button({icon:"delete-left",color:"secondary",click:()=>{document.getElementById(l.id).value=null}}))),"function"!=typeof l.addctl&&!0!==l.addctl||("function"==typeof l.addctl?a.push(new button({icon:"plus",color:"primary",click:l.addctl})):"select"===l.type&&null!==l.dbname&&a.push(new button({icon:"plus",color:"primary","data-dbname":l.dbname,"data-fieldkey":l.fieldkey,"data-fieldname":l.fieldname,"data-label":l.label,click:e=>{let t=e.currentTarget,a=t.dataset.dbname,n=t.dataset.fieldkey,i=t.dataset.fieldname,d=t.dataset.label;new dlg.inputbox("text","Name",((e,d)=>{db.api.create({name:a,sender:t,data:{[i]:d.value}},(e=>{e&&db.api.option({name:a,fieldkey:n,fieldname:i,sender:t},(t=>{if(t){let a=document.getElementById(l.id);core.replaceChild(a,new option.select({selected:e,item:t})),a.value=e,a.dispatchEvent(new Event("modify"))}}))}))}),`Add New ${d}`).show()}}))),"function"!=typeof l.editctl&&!0!==l.editctl||("function"==typeof l.editctl?a.push(new button({icon:"pen",color:"secondary",click:l.editctl})):"select"===l.type&&null!==l.dbname&&a.push(new button({icon:"pen",color:"secondary","data-dbname":l.dbname,"data-fieldkey":l.fieldkey,"data-fieldname":l.fieldname,"data-label":l.label,click:e=>{let t=e.currentTarget,a=document.getElementById(l.id),n=a.options[a.selectedIndex].text,i=a.value,d=t.dataset.dbname,o=t.dataset.fieldkey,c=t.dataset.fieldname,r=t.dataset.label;new dlg.inputbox(new input({type:"text",value:n,name:"value",required:!0}),"Name",((e,a)=>{db.api.update({name:d,sender:t,id:i,data:{[c]:a.value}},(e=>{e&&db.api.option({name:d,fieldkey:o,fieldname:c,sender:t},(t=>{if(t){let a=document.getElementById(l.id);core.replaceChild(a,new option.select({selected:e,item:t})),a.value=e,a.dispatchEvent(new Event("modify"))}}))}))}),`Edit ${r}`).show()}}))),"function"!=typeof l.copyctl&&!0!==l.copyctl||("function"==typeof l.copyctl?a.push(new button({icon:"copy",color:"success",click:l.copyctl})):"select"===l.type&&null!==l.dbname?a.push(new button({icon:"copy",color:"success","data-dbname":l.dbname,"data-fieldkey":l.fieldkey,"data-fieldname":l.fieldname,"data-label":l.label,click:e=>{let t=e.currentTarget,a=document.getElementById(l.id),n=a.options[a.selectedIndex].text,i=t.dataset.dbname,d=t.dataset.fieldkey,o=t.dataset.fieldname,c=t.dataset.label;new dlg.inputbox(new input({type:"text",value:`Copy of ${n}`,name:"value",required:!0}),"Name",((e,a)=>{db.api.create({name:i,sender:t,data:{[o]:a.value}},(e=>{e&&db.api.option({name:i,fieldkey:d,fieldname:o,sender:t},(t=>{if(t){let a=document.getElementById(l.id);core.replaceChild(a,new option.select({selected:e,item:t})),a.value=e,a.dispatchEvent(new Event("modify"))}}))}))}),`Copy ${c}`).show()}})):a.push(new button({icon:{type:"far",icon:"clipboard"},color:"secondary",click:()=>{try{let e=document.getElementById(l.id).value;navigator.clipboard.writeText(e),new toast("/","Copied to clipboard").show()}catch(e){new toast("!!",`Error when copy code to clipboard. ${e}`).show()}}}))),"function"!=typeof l.deletectl&&!0!==l.deletectl||("function"==typeof l.deletectl?a.push(new button({icon:"trash-can",color:"danger",click:l.deletectl})):"select"===l.type&&null!==l.dbname&&a.push(new button({icon:"trash-can",color:"danger","data-dbname":l.dbname,"data-fieldkey":l.fieldkey,"data-fieldname":l.fieldname,"data-label":l.label,click:e=>{let t=e.currentTarget,a=document.getElementById(l.id),n=a.options[a.selectedIndex].text,i=a.value,d=t.dataset.dbname,o=t.dataset.fieldkey,c=t.dataset.fieldname,r=t.dataset.label;new dlg.confirmbox("!!",`Are you sure delete <b>${n}</b> record?`,[{label:"Yes, delete",color:"danger",click:()=>{db.api.delete({name:d,id:i},(e=>{e&&db.api.option({name:d,fieldkey:o,fieldname:c,sender:t},(e=>{e&&(core.replaceChild(a,new option.select({item:e})),a.value=null,a.dispatchEvent(new Event("modify")))}))}))}},{label:"Cancel"}],`Delete ${r}`).show()}}))),"function"==typeof l.managectl&&a.push(new button({icon:"sliders",color:"secondary",click:l.managectl})));let n=null;l.helper&&(n=new div({id:`${l.id}_helper`,class:"form-text",elem:l.helper}));let i=null;l.valid&&(i=new div({class:`valid-${l.validitytype}`,elem:l.valid}));let d=null;l.invalid&&(d=new div({class:`invalid-${l.validitytype}`,elem:l.invalid}));let o=null;l.option&&"select"!==l.type&&(o=new tag({tag:"datalist",id:`${l.id}-dl`,elem:new option.select({item:l.option,selected:l.value})}));let c=null;if(l.label&&!l.hidelabel){let e=null;e=["checkbox","radio","switch","file"].includes(l.type)?"form-check-label":l.labelsize?"col-form-label":"form-label",c=new label({for:l.id,label:l.label,col:l.labelsize,class:e})}if(["date","datetime","month","datetime-local","time","week"].indexOf(l.type)>-1)switch(l.type){case"date":l.value=moment(l.value).format("YYYY-MM-DD");break;case"month":l.value=moment(l.value).format("YYYY-MM");break;default:l.value=moment(l.value).format()}switch(l.type){case"switch":case"checkbox":case"radio":l=core.merge(l,{tag:"input",class:"form-check-input",type:"switch"===l.type?"checkbox":l.type,"aria-label":l.hidelabel&&l.label?l.label:null,indeterminate:!(!l.indeterminate||"checkbox"!==l.type)||null});break;case"textarea":l=core.merge(l,{tag:"textarea",class:[l.plaintext&&l.readonly?"form-control-plaintext":"form-control",!l.weight||l.before||l.after?null:`form-control-${l.weight}`],"aria-label":l.hidelabel&&l.label?l.label:null,elem:l.value}),delete l.value;break;case"select":l=core.merge(l,{tag:"select",class:[l.plaintext&&l.readonly?"form-select-plaintext":"form-select",!l.weight||l.before||l.after||null!==l.addctl?null:`form-select-${l.weight}`],"aria-label":l.hidelabel&&l.label?l.label:null,elem:new option.select({item:l.option,selected:l.value})});break;case"datalist":l=core.merge(l,{tag:"datalist",elem:new option.select({item:l.option,selected:l.value})});break;default:l=core.merge(l,{tag:"input",class:["range"!==l.type?core.combineArray([l.plaintext&&l.readonly?"form-control-plaintext":"form-control",,l.weight&&!(l.before||l.after||null!==l.addctl||"number"===l.type&&!0===l.numctl)?`form-control-${l.weight}`:null]," "):"form-range","color"===l.type?core.combineArray(["form-control-color",l.floatlabel?"w-100":null]," "):null],"aria-label":l.hidelabel&&l.label?l.label:null,list:l.option?`${l.id}-dl`:null})}delete l.label,delete l.hidelabel,delete l.floatlabel,delete l.inline,delete l.labelsize,delete l.ctlsize,delete l.size,delete l.weight,delete l.helper,delete l.option,delete l.numctl,delete l.addctl,delete l.deletectl,delete l.editctl,delete l.copyctl,delete l.managectl,delete l.validitytype,delete l.valid,delete l.invalid,delete l.before,delete l.after,delete l.plaintext,delete l.container,delete l.flex,delete l.textWarp,delete l.dbname,delete l.fieldkey,delete l.fieldname;let r=new tag(l),s=[];t&&t.length>0&&s.push(...t),c&&e.floatlabel?(s.push(new div({class:"form-floating flex-grow-1",elem:[r,c]})),c=null):s.push(r),o&&s.push(o),a&&a.length>0&&s.push(...a),i&&s.push(i),d&&s.push(d),"hidden"===e.type?s=[new div({display:"none",elem:s})]:e.flex?s=[new div({display:"flex",elem:s})]:["checkbox","radio","switch"].includes(e.type)?(s.push(c),s=[new div({class:["form-check",e.label&&e.inline?"form-check-inline":null,"switch"===e.type?"form-switch":null,e.valid||e.invalid?"has-validation":null],elem:s}),n]):(e.container?s=[new div({class:["input-group",e.weight?`input-group-${e.weight}`:null,e.valid||e.invalid?"has-validation":null],flex:e.nowrap?"nowrap":null,elem:s}),n]:s.push(n),(e.labelsize||e.ctlsize)&&(s=[new div({col:e.ctlsize||"auto",elem:s})]),s.unshift(c)),e.size?super.data={elem:new div({badge:e.badge,col:!e.size||e.size,position:"tooltip"===e.validitytype?"relative":null,elem:s})}:super.data={badge:e.badge,position:"tooltip"===e.validitytype?"relative":null,elem:s}}}}