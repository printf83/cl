"use strict";import css from"./css/animation.css";import css2 from"./css/query.css";import*as core from"./core.js";import modal from"./modal.js";import input from"./input.js";import div from"./div.js";import tab from"./tab.js";import button from"./button.js";const defaultBuildOption={data:{filter:null,sort:null,limit:10,skip:0,field:{__v:0}},limit:{min:1,max:100,step:1},skip:{min:1,max:100,step:1},field:[{value:"_id",label:"ID",type:"text"}],useopricon:!1},defaultFilterBtnOption={icon:"plus",color:"primary",label:null,col:null,container:null},defaultFilterBuildOption={id:null,field:null,add:null,useopricon:!1},defaultSortBtnOption={icon:"plus",color:"primary",label:null,col:null,container:null},defaultSortBuildOption={id:null,field:null,add:null,useopricon:!1},defaultFieldBuildOption={field:null},defaultLimitBuildOption={min:0,max:100,step:5},defaultSkipBuildOption={min:0,max:100,step:5,limit:0};let db_filter={},db_sort={},fn={isPrototypeExists:(e,l)=>{if(e&&"object"==typeof e)try{if(void 0!==e[l])return!0}catch(e){return!1}return!1},filter:{opr:(e,l)=>{let t=null;if(l)switch(l){case"text":case"tel":case"email":t=[{value:"$eqlike",label:e?"&#xf52c; &#xf069;":"Like"},{value:"$nelike",label:e?"&#xf53e; &#xf069;":"Not Like"},{value:"$eq",label:e?"&#xf52c;":"Equal"},{value:"$ne",label:e?"&#xf53e;":"Not Equal"}];break;case"select":case"check":t=[{value:"$eq",label:e?"&#xf52c;":"Equal"},{value:"$ne",label:e?"&#xf53e;":"Not Equal"}];break;case"date":case"number":t=[{value:"$eq",label:e?"&#xf52c;":"Equal"},{value:"$ne",label:e?"&#xf53e;":"Not Equal"},{value:"$gte",label:e?"&#xf532;":"More Than"},{value:"$lte",label:e?"&#xf537;":"Less Than"}];break;default:console.error("Unhandle query.fn.filter.opr itemtype : "+l)}return t},item:(e,l,t,i,n)=>{t||(t=l[0].value);let o=l.map((e=>({value:e.value,label:e.label}))),r=new input({type:"select",name:"from",onchange:l=>{fn.filter.change(l,e)},option:o,value:t}),a=null,u=l.find((e=>e.value===t));a=fn.filter.opr(e,u?u.type:null),(i=i||(a?a[0].value:null))&&"$regex"===i?n&&n.startsWith("^((?!")?(i="$nelike",n=n.substring(5,n.length-5)):i="$eqlike":i&&"$exists"===i&&(i=n?"$ne":"$eq",n="");let s=new input({class:[e?"font-fa":null].join(" "),type:"select",name:"opr",option:a,value:i});return new div({display:"flex",elem:new div({container:"fluid",padding:0,elem:[new div({row:!0,elem:new div({col:!0,elem:new div({display:"flex",gap:2,elem:[r,s,new button({color:"danger",icon:"trash",click:e=>{fn.filter.remove(e)}})]})})}),new div({row:!0,paddingY:2,elem:new div({col:!0,elem:new input({type:u&&u.type?u.type:"text",name:"value",required:!0,value:n,placeholder:u.placeholder?u.placeholder:null,option:u&&u.option?u.option:null})})})]})})},add:(e,l)=>{let t=e.currentTarget.getAttribute("data-cl-container"),i=document.getElementById(t),n=db_filter[t];core.prependChild(i,new div(["item",l?"cl-fadeslidein":null].filter(Boolean).join(" "),fn.filter.item(n.useopricon,n.field,null,null,null))),setTimeout((e=>{e.querySelectorAll(".cl-fadeslidein")[0].classList.remove("cl-fadeslidein")}),500,i)},change:(e,l)=>{let t=e.currentTarget,i=t.closest(".cl-filter-rule").getAttribute("id"),n=db_filter[i],o=t.closest(".item").querySelectorAll("select[name='opr']")[0],r=t.closest(".item").querySelectorAll("[name='value']")[0],a=core.getValue(t),u=n.field.find((e=>e.value===a)),s=fn.filter.opr(l,u?u.type:null);core.replaceWith(o.parentNode,new input({class:[l?"font-fa":null].filter(Boolean).join(" "),type:"select",name:"opr",value:core.getValue(o),option:s})),core.replaceWith(r.parentNode,new input({type:u&&u.type?u.type:"text",name:"value",placeholder:u.placeholder?u.placeholder:null,value:core.getValue(r),option:u&&u.option?u.option:null}))},remove:e=>{let l=e.currentTarget;l.closest(".item").classList.add("cl-fadeslideout"),setTimeout((e=>{core.removeElement(e.closest(".item"))}),500,l)},get:e=>{let l=null,t=e.querySelectorAll("select[name='from']");if(t&&t.length>0){let e=[];t.forEach((l=>{let t=l.closest(".item").querySelectorAll("select[name='opr']")[0],i=core.getValue(t),n=l.closest(".item").querySelectorAll("[name='value']")[0];"$eqlike"===i||"$nelike"===i?"$eqlike"===i?(i="$eq",n={$regex:core.getValue(n),$options:"i"}):(i="$ne",n={$regex:"^((?!"+core.getValue(n)+").)*$",$options:"i"}):(n=core.getValue(n),null===n&&("$eq"===i?n={$exists:!1,$eq:null}:"$ne"===i&&(n={$exists:!0,$ne:null}))),e.push({f:core.getValue(l),o:i,v:n})})),e.sort(((e,l)=>e.f>l.f?1:l.f>e.f?-1:0));let i=[],n=null;e.forEach((e=>{null===n||n!=e.f?fn.isPrototypeExists(e.v,"$regex")||fn.isPrototypeExists(e.v,"$exists")?i.push([{[e.f]:e.v}]):i.push([{[e.f]:{[e.o]:e.v}}]):fn.isPrototypeExists(e.v,"$regex")||fn.isPrototypeExists(e.v,"$exists")?i[i.length-1].push({[e.f]:e.v}):i[i.length-1].push({[e.f]:{[e.o]:e.v}}),n=e.f})),l={$and:[]},i.forEach((e=>{if(1===e.length)l.$and.push(e[0]);else{let t=[];e.forEach((e=>{t.push(e)})),l.$and.push({$or:t})}}))}return l},btn:e=>(e=core.extend({},defaultFilterBtnOption,e),new button({icon:e.icon,color:e.color,col:e.col,label:e.label,"data-cl-container":e.container,click:e=>{fn.filter.add(e,!0)}})),build:(e,l)=>{let t=(e=core.extend({},defaultFilterBuildOption,e)).id||core.UUID(),i=[];l&&l.$and&&l.$and.forEach((l=>{if(l.$or)l.$or.forEach((l=>{let t=Object.keys(l)[0],n=l[t],o=Object.keys(n)[0],r=n[o];i.push(new div("item",fn.filter.item(e.useopricon,e.field,t,o,r)))}));else{let t=Object.keys(l)[0],n=l[t],o=Object.keys(n)[0],r=n[o];i.push(new div("item",fn.filter.item(e.useopricon,e.field,t,o,r)))}})),e.add&&i.push(new div("item",e.add));let n=new div({padding:0,container:"fluid",elem:new div({gap:2,row:!0,rowCol:1,elem:new div({col:!0,class:"cl-filter-rule",id:t,elem:i})})});return delete e.id,delete e.add,db_filter[t]=e,n}},sort:{opr:(e,l)=>{let t=null;if(l)if(e)switch(l){case"text":case"email":case"select":t=[{value:1,label:"&#xf15d;"},{value:-1,label:"&#xf15e;"}];break;case"tel":case"check":t=[{value:1,label:"&#xf884;"},{value:-1,label:"&#xf885;"}];break;case"date":case"number":t=[{value:1,label:"&#xf162;"},{value:-1,label:"&#xf163;"}];break;default:console.error("Unhandle query.fn.sort.opr itemtype : "+l)}else t=[{value:1,label:"Ascending"},{value:-1,label:"Descending"}];return t},item:(e,l,t,i)=>{t||(t=l[0].value);let n=l.map((e=>({value:e.value,label:e.label}))),o=new input({type:"select",name:"from",onchange:l=>{fn.sort.change(l,e)},option:n,value:t}),r=null,a=l.find((e=>e.value===t));r=fn.sort.opr(e,a?a.type:null);let u=new input({class:[e?"font-fa":null].filter(Boolean).join(" "),type:"select",name:"opr",option:r,value:i||(r?r[0].value:null)});return new div({display:"flex",elem:new div({container:"fluid",padding:0,elem:new div({row:!0,paddingBottom:2,elem:new div({col:!0,elem:new div({display:"flex",gap:2,elem:[o,u,new button({color:"danger",icon:"trash",click:e=>{fn.sort.remove(e)}})]})})})})})},add:(e,l)=>{let t=e.currentTarget.getAttribute("data-cl-container"),i=document.getElementById(t),n=db_sort[t];core.prependChild(i,new div(["item",l?"cl-fadeslidein":null].filter(Boolean).join(" "),fn.sort.item(n.useopricon,n.field,null,null))),setTimeout((e=>{e.querySelectorAll(".cl-fadeslidein")[0].classList.remove("cl-fadeslidein")}),500,i)},change:(e,l)=>{let t=e.currentTarget,i=t.closest(".cl-sort-rule").getAttribute("id"),n=db_sort[i],o=t.closest(".item").querySelectorAll("select[name='opr']")[0],r=core.getValue(t),a=n.field.find((e=>e.value===r)),u=fn.sort.opr(l,a?a.type:null);core.replaceWith(o.parentNode,new input({class:[l?"font-fa":null].filter(Boolean).join(" "),type:"select",name:"opr",value:core.getValue(o),option:u}))},remove:e=>{let l=e.currentTarget;l.closest(".item").classList.add("cl-fadeslideout"),setTimeout((e=>{core.removeElement(e.closest(".item"))}),500,l)},get:e=>{let l=null,t=e.querySelectorAll("select[name='from']");return t&&t.length>0&&(l={},t.forEach((e=>{let t=e.closest(".item").querySelectorAll("select[name='opr']")[0];l[core.getValue(e)]=parseInt(core.getValue(t),10)}))),l},btn:e=>(e=core.extend({},defaultSortBtnOption,e),new button({icon:e.icon,color:e.color,col:e.col,label:e.label,"data-cl-container":e.container,click:e=>{fn.sort.add(e,!0)}})),build:(e,l)=>{let t=(e=core.extend({},defaultSortBuildOption,e)).id||core.UUID(),i=[];l&&Object.keys(l).forEach((t=>{l[t]&&i.push(new div("item",fn.sort.item(e.useopricon,e.field,t,l[t])))})),e.add&&i.push(new div("item",e.add));let n=new div({padding:0,container:"fluid",elem:new div({gap:2,row:!0,rowCol:1,elem:new div({col:!0,class:"cl-sort-rule",id:t,elem:i})})});return delete e.id,delete e.add,db_sort[t]=e,n}},field:{get:e=>{let l=null,t=e.querySelectorAll("input[name]");return t&&t.length>0&&(l={},t.forEach((e=>{core.getValue(e)||(l[e.getAttribute("name")]=0)}))),l},build:(e,l)=>{e=core.extend({},defaultFieldBuildOption,e);let t=[];return t.push(new input({type:"checkbox",label:"Version",name:"__v",checked:!l||!fn.isPrototypeExists(l,"__v")||0!==l.__v})),e.field&&e.field.forEach((e=>{t.push(new input({type:"checkbox",label:e.label,name:e.value,checked:!l||!fn.isPrototypeExists(l,e.value)||0!==l[e.value]}))})),new div({padding:0,container:"fluid",elem:new div({gap:2,row:!0,rowCol:1,elem:new div({col:!0,class:"cl-field-rule",id:e.id,elem:t})})})}},limit:{get:e=>{let l=e.querySelectorAll("input[name='limit']")[0];return core.getValue(l)},build:(e,l)=>(e=core.extend({},defaultLimitBuildOption,e),new input({type:"number",name:"limit",min:e.min,max:e.max,step:e.step,value:l,numctl:!0,required:!0,label:"Record per Page"}))},skip:{get:e=>{let l=e.querySelectorAll("input[name='step']")[0];return core.getValue(l)-1},build:(e,l)=>(e=core.extend({},defaultSkipBuildOption,e),new input({type:"number",name:"step",min:e.min,max:e.max,step:e.step,value:l/e.limit+1,numctl:!0,required:!0,label:"Current Page"}))},get:e=>{let l=e.getElementsByClassName("cl-filter-rule")[0],t=e.getElementsByClassName("cl-sort-rule")[0],i=e.getElementsByClassName("cl-field-rule")[0],n=e.querySelectorAll("input[name='limit']")[0].parentNode,o=e.querySelectorAll("input[name='step']")[0].parentNode,r=fn.filter.get(l),a=fn.sort.get(t),u=fn.field.get(i),s=fn.limit.get(n);return{filter:r,sort:a,field:u,limit:s,skip:fn.skip.get(o)*s}}};function btnBuilder(e,l,t,i){let n=Array.isArray(e)?e:[e];return i&&1===n.length&&n.push("Cancel"),n.map(((e,i)=>e instanceof Function?{label:i<=l.length?l[i]:`Button ${i+1}`,color:0===i&&t?t:null,click:0===i?l=>!!core.validate(l.closest(".modal"))&&(e(l),!0):e}:"object"==typeof e?e:"string"==typeof e?{label:e}:void 0))}function elemBuilder(e){e=core.extend({},defaultBuildOption,e);let l=core.UUID();return new tab({flush:!0,headAlign:"center",type:"pill",item:[{label:"Filter",icon:"filter",elem:fn.filter.build({add:fn.filter.btn({container:`${l}-filter`,label:"Add new filter",col:12}),id:`${l}-filter`,useopricon:e.useopricon,field:e.field},e.data.filter)},{label:"Sort",icon:"sort",elem:fn.sort.build({add:fn.sort.btn({container:`${l}-sort`,label:"Add new sort",col:12}),id:`${l}-sort`,useopricon:e.useopricon,field:e.field},e.data.sort)},{label:"Fields",icon:"tasks",elem:fn.field.build({field:e.field},e.data.field)},{label:"Page",icon:"list-ol",elem:[new div({padding:0,class:"container cl-page-rule",elem:new div({gap:2,row:!0,rowCol:1,elem:[new div({col:!0,elem:fn.limit.build({min:e.limit.min,max:e.limit.max,step:e.limit.step},e.data.limit)}),new div({col:!0,elem:fn.skip.build({min:e.skip.min,max:e.skip.max,step:e.skip.step,limit:e.data.limit},e.data.skip)})]})})]}]})}export class dialog extends modal{constructor(...e){e&&e.length>0?super({title:"Query",elem:elemBuilder(e[0]),button:btnBuilder((l=>{e[1][0](l,fn.get(l.closest(".modal")))}),["Okay","Cancel","Retry"],null,!0),debug:e.length>2&&!0===e[2]?.debug}):super()}}export class filter extends modal{constructor(...e){if(e&&e.length>0){let l=core.UUID();super({title:"Filter",bodyclass:"pb-2",bodyminheight:"7.3rem",elem:fn.filter.build({id:l,useopricon:e[0].useopricon,field:e[0].field},e[0].data),button:btnBuilder((l=>{e[1][0](l,fn.filter.get(l.closest(".modal")))}),["Okay","Cancel","Retry"],null,!0),footer:fn.filter.btn({container:l}),debug:e.length>2&&!0===e[2]?.debug})}else super()}}export class sort extends modal{constructor(...e){if(e&&e.length>0){let l=core.UUID();super({title:"Sort",bodyclass:"pb-2",bodyminheight:"4.4rem",elem:fn.sort.build({id:l,useopricon:e[0].useopricon,field:e[0].field},e[0].data),button:btnBuilder((l=>{e[1][0](l,fn.sort.get(l.closest(".modal")))}),["Okay","Cancel","Retry"],null,!0),footer:fn.sort.btn({container:l}),debug:e.length>2&&!0===e[2]?.debug})}else super()}}export class field extends modal{constructor(...e){e&&e.length>0?super({title:"Field",elem:fn.field.build({field:e[0].field},e[0].data),button:btnBuilder((l=>{e[1][0](l,fn.field.get(l.closest(".modal")))}),["Okay","Cancel","Retry"],null,!0),debug:e.length>2&&!0===e[2]?.debug}):super()}}export class limit extends modal{constructor(...e){e&&e.length>0?super({title:"Limit",elem:fn.limit.build({min:e[0].min,max:e[0].max,step:e[0].step},e[0].data),button:btnBuilder((l=>{e[1][0](l,fn.limit.get(l.closest(".modal")))}),["Okay","Cancel","Retry"],null,!0),debug:e.length>2&&!0===e[2]?.debug}):super()}}export class page extends modal{constructor(...e){e&&e.length>0?super({title:"Page",elem:fn.skip.build({min:e[0].min,max:e[0].max,step:e[0].step,limit:e[0].limit},e[0].data),button:btnBuilder((l=>{e[1][0](l,fn.skip.get(l.closest(".modal"))*e[0].limit)}),["Okay","Cancel","Retry"],null,!0),debug:e.length>2&&!0===e[2]?.debug}):super()}}